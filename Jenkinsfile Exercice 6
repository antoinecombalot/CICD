pipeline {
    agent {
        docker {
            image 'python:3.11-slim'
            args '-u root'
        }
    }
    
    // üéõÔ∏è PARAM√àTRES DU BUILD
    parameters {
        string(
            name: 'APP_PORT',
            defaultValue: '5000',
            description: 'Port de l\'application backend'
        )
        choice(
            name: 'ENVIRONMENT',
            choices: ['development', 'testing', 'staging', 'production'],
            description: 'Environnement de d√©ploiement'
        )
        string(
            name: 'APP_VERSION_SUFFIX',
            defaultValue: '',
            description: 'Suffixe de version (ex: -beta, -rc1)'
        )
        booleanParam(
            name: 'ENABLE_DEBUG',
            defaultValue: false,
            description: 'Activer le mode debug Flask'
        )
        string(
            name: 'DEPLOY_TARGET',
            defaultValue: '192.168.238.130',
            description: 'IP du serveur de d√©ploiement'
        )
    }
    
    // üåç VARIABLES D'ENVIRONNEMENT
    environment {
        PYTHONPATH = "${WORKSPACE}/backend"
        BUILD_VERSION = "1.0.${env.BUILD_NUMBER}${params.APP_VERSION_SUFFIX}"
        ARTIFACT_PREFIX = "cicd-project-${env.BUILD_VERSION}"
        
        // Variables configurables depuis les param√®tres
        APP_PORT = "${params.APP_PORT}"
        DEPLOY_ENV = "${params.ENVIRONMENT}"
        DEBUG_MODE = "${params.ENABLE_DEBUG}"
        DEPLOY_SERVER = "${params.DEPLOY_TARGET}"
        DEPLOY_USER = 'deploy'
        
        // Variables d√©riv√©es
        APP_NAME = "CICD-${env.DEPLOY_ENV.toUpperCase()}"
        CONFIG_FILE = "app_config_${env.DEPLOY_ENV}.json"
    }
    
    stages {
        stage('üîç Checkout & Parameters Info') {
            steps {
                echo "üöÄ Pipeline ${env.BUILD_VERSION} - Environnement: ${env.DEPLOY_ENV}"
                sh '''
                    echo "======================================"
                    echo "üìã PARAM√àTRES DE BUILD"
                    echo "======================================"
                    echo "üéØ Environment: ${DEPLOY_ENV}"
                    echo "üîå Port Application: ${APP_PORT}"
                    echo "üêõ Mode Debug: ${DEBUG_MODE}"
                    echo "üì¶ Version: ${BUILD_VERSION}"
                    echo "üåê Serveur Deploy: ${DEPLOY_SERVER}"
                    echo "üì± Nom Application: ${APP_NAME}"
                    echo "‚öôÔ∏è Fichier Config: ${CONFIG_FILE}"
                    echo "======================================"
                    
                    echo "üìÅ Structure du projet:"
                    ls -la
                    find . -name "*.py" -type f
                '''
            }
        }
        
        stage('üîß Setup Environment') {
            steps {
                sh '''
                    pip install --upgrade pip
                    apt-get update && apt-get install -y zip unzip openssh-client jq
                    
                    # D√©pendances Python avec versions selon l'environnement
                    if [ "${DEPLOY_ENV}" = "production" ]; then
                        echo "üì¶ Installation versions production (fig√©es)"
                        pip install flask==3.1.2 flask-cors==4.0.0 requests==2.31.0
                    else
                        echo "üì¶ Installation versions d√©veloppement (flexibles)"
                        pip install flask flask-cors requests
                    fi
                    
                    pip install pytest pytest-html pytest-cov
                    
                    echo "‚úÖ Setup termin√© pour environnement: ${DEPLOY_ENV}"
                '''
            }
        }
        
        stage('üß™ Run Tests') {
            steps {
                sh '''
                    export PYTHONPATH="${WORKSPACE}/backend"
                    
                    # Tests avec configuration selon l'environnement
                    if [ "${DEPLOY_ENV}" = "production" ]; then
                        echo "üî¨ Tests complets pour production"
                        pytest -v --junitxml=test-results.xml --html=test-report.html --cov=backend backend/
                    else
                        echo "üî¨ Tests rapides pour ${DEPLOY_ENV}"
                        pytest -v --junitxml=test-results.xml --html=test-report.html backend/
                    fi
                '''
            }
            post {
                always {
                    junit 'test-results.xml'
                    archiveArtifacts 'test-report.html'
                }
            }
        }
        
        stage('‚öôÔ∏è Generate Configuration') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                echo '‚öôÔ∏è G√©n√©ration de la configuration applicative'
                sh '''
                    echo "üìù Cr√©ation du fichier de configuration: ${CONFIG_FILE}"
                    
                    # G√©n√©ration de la configuration JSON
                    cat > ${CONFIG_FILE} << EOF
{
    "application": {
        "name": "${APP_NAME}",
        "version": "${BUILD_VERSION}",
        "environment": "${DEPLOY_ENV}",
        "debug": ${DEBUG_MODE}
    },
    "server": {
        "host": "0.0.0.0",
        "port": ${APP_PORT},
        "threaded": true
    },
    "database": {
        "enabled": $([ "${DEPLOY_ENV}" = "development" ] && echo "false" || echo "true"),
        "connection_pool": $([ "${DEPLOY_ENV}" = "production" ] && echo "20" || echo "5")
    },
    "logging": {
        "level": "$([ "${DEPLOY_ENV}" = "production" ] && echo "WARNING" || echo "DEBUG")",
        "format": "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    },
    "security": {
        "cors_enabled": $([ "${DEPLOY_ENV}" = "development" ] && echo "true" || echo "false"),
        "csrf_protection": $([ "${DEPLOY_ENV}" = "production" ] && echo "true" || echo "false")
    },
    "build_info": {
        "build_number": "${BUILD_NUMBER}",
        "build_date": "$(date -Iseconds)",
        "git_commit": "${GIT_COMMIT:-unknown}",
        "jenkins_url": "${BUILD_URL:-unknown}"
    }
}
EOF
                    
                    echo "‚úÖ Configuration g√©n√©r√©e:"
                    cat ${CONFIG_FILE}
                    
                    # Validation JSON
                    if command -v jq >/dev/null 2>&1; then
                        echo "üîç Validation JSON..."
                        jq . ${CONFIG_FILE} && echo "‚úÖ JSON valide" || echo "‚ùå JSON invalide"
                    fi
                '''
            }
        }
        
        stage('üì¶ Build Packages') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                sh '''
                    mkdir -p dist/frontend dist/backend
                    
                    echo "üé® Build Frontend avec configuration"
                    cat > dist/frontend/index.html << EOF
<!DOCTYPE html>
<html>
<head>
    <title>${APP_NAME} - v${BUILD_VERSION}</title>
    <style>
        body { font-family: Arial; margin: 40px; background: $([ "${DEPLOY_ENV}" = "production" ] && echo "#f8f9fa" || echo "#e3f2fd"); }
        .header { text-align: center; margin-bottom: 30px; }
        .config { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .env-$(echo ${DEPLOY_ENV}) { border-left: 4px solid $([ "${DEPLOY_ENV}" = "production" ] && echo "#28a745" || [ "${DEPLOY_ENV}" = "staging" ] && echo "#ffc107" || echo "#007bff"); }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ ${APP_NAME}</h1>
        <p>Version ${BUILD_VERSION} - Environnement: ${DEPLOY_ENV}</p>
    </div>
    
    <div class="config env-${DEPLOY_ENV}">
        <h2>üìä Configuration</h2>
        <ul>
            <li><strong>Port Backend:</strong> ${APP_PORT}</li>
            <li><strong>Mode Debug:</strong> ${DEBUG_MODE}</li>
            <li><strong>Build:</strong> #${BUILD_NUMBER}</li>
            <li><strong>Date:</strong> $(date)</li>
        </ul>
        
        <p><a href="http://${DEPLOY_SERVER}:${APP_PORT}/" target="_blank">üîó Acc√©der √† l'API Backend</a></p>
        <p><a href="http://${DEPLOY_SERVER}:${APP_PORT}/config" target="_blank">‚öôÔ∏è Voir la configuration API</a></p>
    </div>
</body>
</html>
EOF
                    
                    echo "‚öôÔ∏è Build Backend avec configuration dynamique"
                    # Copie de l'application originale
                    cp backend/app.py dist/backend/
                    
                    # Copie de la configuration g√©n√©r√©e
                    cp ${CONFIG_FILE} dist/backend/
                    
                    # G√©n√©ration des requirements selon l'environnement
                    cat > dist/backend/requirements.txt << EOF
$([ "${DEPLOY_ENV}" = "production" ] && echo "flask==3.1.2" || echo "flask>=3.1.0")
$([ "${DEPLOY_ENV}" = "production" ] && echo "flask-cors==4.0.0" || echo "flask-cors>=4.0.0")
$([ "${DEPLOY_ENV}" = "production" ] && echo "requests==2.31.0" || echo "requests>=2.31.0")
EOF
                    
                    # Application configur√©e dynamiquement
                    cat > dist/backend/app_configured.py << 'EOF'
#!/usr/bin/env python3
import json
import os
import sys
from flask import Flask, jsonify

# Chargement de la configuration
def load_config():
    config_files = [
        'app_config_production.json',
        'app_config_staging.json', 
        'app_config_testing.json',
        'app_config_development.json'
    ]
    
    for config_file in config_files:
        if os.path.exists(config_file):
            print(f"üìñ Chargement configuration: {config_file}")
            with open(config_file, 'r') as f:
                return json.load(f)
    
    print("‚ö†Ô∏è Aucun fichier de configuration trouv√©, utilisation des valeurs par d√©faut")
    return {
        "application": {"name": "CICD-DEFAULT", "version": "1.0.0", "environment": "development", "debug": True},
        "server": {"host": "0.0.0.0", "port": 5000, "threaded": True}
    }

config = load_config()
app = Flask(__name__)

# Configuration Flask depuis le fichier JSON
app.config['DEBUG'] = config['application']['debug']
app.config['TESTING'] = config['application']['environment'] == 'testing'

# Import de l'application originale
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

try:
    from app import *  # Import des routes existantes
except ImportError as e:
    print(f"‚ö†Ô∏è Impossible d'importer l'app originale: {e}")

# Route de configuration
@app.route('/config')
def get_config():
    return jsonify(config)

# Route de sant√©
@app.route('/health')
def health_check():
    return jsonify({
        "status": "healthy",
        "application": config['application']['name'],
        "version": config['application']['version'],
        "environment": config['application']['environment'],
        "port": config['server']['port']
    })

if __name__ == '__main__':
    print(f"üöÄ D√©marrage {config['application']['name']} v{config['application']['version']}")
    print(f"üåç Environnement: {config['application']['environment']}")
    print(f"üîå Port: {config['server']['port']}")
    print(f"üêõ Debug: {config['application']['debug']}")
    
    app.run(
        host=config['server']['host'],
        port=int(config['server']['port']),
        debug=config['application']['debug'],
        threaded=config['server']['threaded']
    )
EOF
                    
                    # Service systemd avec port dynamique
                    cat > dist/backend/backend-app.service << EOF
[Unit]
Description=${APP_NAME} Backend
After=network.target

[Service]
Type=simple
User=deploy
WorkingDirectory=/opt/backend-app
ExecStart=/usr/bin/python3 app_configured.py
Restart=always
RestartSec=5
Environment=FLASK_ENV=${DEPLOY_ENV}
Environment=APP_PORT=${APP_PORT}

[Install]
WantedBy=multi-user.target
EOF
                    
                    # Archives avec versioning
                    cd dist
                    zip -r "${ARTIFACT_PREFIX}-frontend-${DEPLOY_ENV}.zip" frontend/
                    zip -r "${ARTIFACT_PREFIX}-backend-${DEPLOY_ENV}.zip" backend/
                    cd ..
                    
                    echo "‚úÖ Packages cr√©√©s pour environnement ${DEPLOY_ENV}:"
                    ls -la dist/
                    
                    echo "üìã Contenu backend g√©n√©r√©:"
                    ls -la dist/backend/
                '''
            }
        }
        
        stage('üöÄ Deploy with Environment Config') {
            when {
                allOf {
                    expression { currentBuild.result != 'FAILURE' }
                    not { equals expected: 'development', actual: params.ENVIRONMENT }
                }
            }
            steps {
                echo "üåê D√©ploiement sur ${env.DEPLOY_ENV} - Port: ${env.APP_PORT}"
                sshagent(['deploy-ssh-key']) {
                    sh '''
                        echo "üì§ D√©ploiement avec configuration ${DEPLOY_ENV}"
                        
                        # Copie des archives
                        scp -o StrictHostKeyChecking=no \\
                            "dist/${ARTIFACT_PREFIX}-frontend-${DEPLOY_ENV}.zip" \\
                            "dist/${ARTIFACT_PREFIX}-backend-${DEPLOY_ENV}.zip" \\
                            ${DEPLOY_USER}@${DEPLOY_SERVER}:/tmp/
                        
                        # D√©ploiement configur√©
                        ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} << 'DEPLOY_EOF'
echo "üõë Arr√™t services existants"
sudo systemctl stop backend-app 2>/dev/null || true

echo "üßπ Nettoyage"
sudo rm -rf /var/www/html/* /opt/backend-app/*

echo "üé® D√©ploiement Frontend ${DEPLOY_ENV}"
cd /tmp
unzip -o ${ARTIFACT_PREFIX}-frontend-${DEPLOY_ENV}.zip
sudo cp -r frontend/* /var/www/html/
sudo chown -R www-data:www-data /var/www/html

echo "‚öôÔ∏è D√©ploiement Backend avec port ${APP_PORT}"
unzip -o ${ARTIFACT_PREFIX}-backend-${DEPLOY_ENV}.zip
sudo cp -r backend/* /opt/backend-app/
sudo chown -R deploy:deploy /opt/backend-app
sudo chmod +x /opt/backend-app/app_configured.py

echo "üì¶ Installation d√©pendances selon environnement"
cd /opt/backend-app
pip3 install --user -r requirements.txt

echo "‚öôÔ∏è Configuration service systemd"
sudo cp backend-app.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable backend-app

echo "üöÄ D√©marrage avec configuration ${DEPLOY_ENV}"
sudo systemctl start backend-app
sleep 8

echo "‚úÖ V√©rification d√©ploiement"
curl -s http://localhost:${APP_PORT}/health || echo "Backend encore en d√©marrage..."
sudo systemctl status backend-app --no-pager -l

echo "üéâ D√©ploiement ${DEPLOY_ENV} termin√© sur port ${APP_PORT}"
DEPLOY_EOF
                    '''
                }
            }
        }
        
        stage('üß™ Environment Verification') {
            when {
                not { equals expected: 'development', actual: params.ENVIRONMENT }
            }
            steps {
                echo 'üîç Tests de v√©rification environnement'
                sshagent(['deploy-ssh-key']) {
                    sh '''
                        sleep 10
                        
                        echo "üåê Test Frontend"
                        FRONTEND_STATUS=$(ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} \\
                            "curl -s -o /dev/null -w '%{http_code}' http://localhost/")
                        
                        echo "üêç Test Backend sur port ${APP_PORT}"
                        BACKEND_STATUS=$(ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} \\
                            "curl -s -o /dev/null -w '%{http_code}' http://localhost:${APP_PORT}/" || echo "000")
                        
                        echo "‚öôÔ∏è Test configuration API"
                        CONFIG_RESPONSE=$(ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} \\
                            "curl -s http://localhost:${APP_PORT}/config" || echo "{}")
                        
                        echo "üè• Test health check"
                        HEALTH_RESPONSE=$(ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} \\
                            "curl -s http://localhost:${APP_PORT}/health" || echo "{}")
                        
                        echo "======================================"
                        echo "üìä R√âSULTATS V√âRIFICATION"
                        echo "======================================"
                        echo "Frontend Status: $FRONTEND_STATUS"
                        echo "Backend Status: $BACKEND_STATUS"
                        echo "Config API: $CONFIG_RESPONSE"
                        echo "Health Check: $HEALTH_RESPONSE"
                        echo "======================================"
                        
                        # Validation des r√©sultats
                        if [ "$FRONTEND_STATUS" = "200" ] && [ "$BACKEND_STATUS" = "200" ]; then
                            echo "‚úÖ D√©ploiement ${DEPLOY_ENV} valid√© sur port ${APP_PORT}"
                        else
                            echo "‚ö†Ô∏è Probl√®me de d√©ploiement d√©tect√©"
                        fi
                    '''
                }
            }
        }
        
        stage('üìä Summary') {
            steps {
                sh '''
                    echo "üéØ R√âSUM√â FINAL"
                    echo "=============="
                    echo "üì¶ Version: ${BUILD_VERSION}"
                    echo "üåç Environnement: ${DEPLOY_ENV}"
                    echo "üîå Port: ${APP_PORT}"
                    echo "üêõ Debug: ${DEBUG_MODE}"
                    echo "üåê URLs:"
                    echo "  Frontend: http://${DEPLOY_SERVER}/"
                    echo "  Backend: http://${DEPLOY_SERVER}:${APP_PORT}/"
                    echo "  Config API: http://${DEPLOY_SERVER}:${APP_PORT}/config"
                    echo "  Health: http://${DEPLOY_SERVER}:${APP_PORT}/health"
                    
                    # Sauvegarde info d√©ploiement
                    cat > deployment-summary.json << EOF
{
    "deployment": {
        "version": "${BUILD_VERSION}",
        "environment": "${DEPLOY_ENV}",
        "port": ${APP_PORT},
        "debug": ${DEBUG_MODE},
        "server": "${DEPLOY_SERVER}",
        "date": "$(date -Iseconds)",
        "urls": {
            "frontend": "http://${DEPLOY_SERVER}/",
            "backend": "http://${DEPLOY_SERVER}:${APP_PORT}/",
            "config": "http://${DEPLOY_SERVER}:${APP_PORT}/config",
            "health": "http://${DEPLOY_SERVER}:${APP_PORT}/health"
        }
    }
}
EOF
                '''
            }
        }
    }
    
    post {
        always {
            script {
                archiveArtifacts artifacts: 'dist/*.zip, deployment-summary.json, app_config_*.json', 
                               fingerprint: true, 
                               allowEmptyArchive: true
            }
        }
        
        success {
            echo "üéâ D√âPLOIEMENT PARAM√âTR√â R√âUSSI!"
            echo "‚úÖ ${env.APP_NAME} v${env.BUILD_VERSION}"
            echo "üåç Environnement: ${env.DEPLOY_ENV}"
            echo "üîå Port configur√©: ${env.APP_PORT}"
        }
        
        failure {
            echo '‚ùå D√âPLOIEMENT PARAM√âTR√â √âCHOU√â!'
        }
    }
}
