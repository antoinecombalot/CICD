pipeline {
    agent {
        docker {
            image 'python:3.11-slim'
            args '-u root'
        }
    }
    
    environment {
        PYTHONPATH = "${WORKSPACE}/backend"
        PROJECT_NAME = 'CICD-Project-Antoine'
    }
    
    stages {
        stage('üîç Checkout & Info') {
            steps {
                echo "üöÄ D√©marrage de la pipeline pour ${env.PROJECT_NAME}"
                echo "üìÇ Workspace: ${env.WORKSPACE}"
                echo "üåø Branche: ${env.GIT_BRANCH}"
                echo "üìù Commit: ${env.GIT_COMMIT}"
                
                sh '''
                    echo "‚úÖ Code source r√©cup√©r√© depuis Git"
                    echo "üìÅ Structure du projet:"
                    ls -la
                    
                    echo ""
                    echo "üêç Fichiers Python trouv√©s:"
                    find . -name "*.py" -type f
                    
                    echo ""
                    echo "üß™ Fichiers de test trouv√©s:"
                    find . -name "*test*.py" -type f
                '''
            }
        }
        
        stage('üîß Setup Environment') {
            steps {
                echo 'üîß Configuration de l\'environnement Python'
                sh '''
                    echo "üì¶ Mise √† jour de pip"
                    python -m pip install --upgrade pip
                    
                    echo "üîç Analyse des d√©pendances requises"
                    if [ -f "requirements.txt" ]; then
                        echo "üìã Installation via requirements.txt:"
                        cat requirements.txt
                        pip install -r requirements.txt
                    else
                        echo "üì¶ Installation des d√©pendances d√©tect√©es pour Flask"
                        pip install flask flask-cors requests
                    fi
                    
                    echo "üß™ Installation des outils de test"
                    pip install pytest pytest-html pytest-cov pytest-xdist
                    
                    echo "‚úÖ Environnement configur√©"
                    echo "üêç Version Python: $(python --version)"
                    echo "üì¶ Packages install√©s:"
                    pip list | grep -E "(flask|pytest|requests)" || pip list | head -10
                '''
            }
        }
        
        stage('üß™ Run Tests') {
            steps {
                echo 'üß™ Ex√©cution des tests unitaires'
                sh '''
                    echo "üî¨ D√©marrage des tests avec pytest"
                    
                    export PYTHONPATH="${WORKSPACE}/backend:${PYTHONPATH}"
                    
                    pytest -v \
                        --junitxml=test-results.xml \
                        --html=test-report.html \
                        --self-contained-html \
                        --cov=backend \
                        --cov-report=html:htmlcov \
                        --cov-report=term-missing \
                        --cov-report=xml:coverage.xml \
                        backend/ || TEST_EXIT_CODE=$?
                    
                    echo ""
                    echo "üìä R√©sultats des tests g√©n√©r√©s:"
                    ls -la test-results.xml test-report.html coverage.xml 2>/dev/null || echo "Certains rapports manquants"
                    
                    exit ${TEST_EXIT_CODE:-0}
                '''
            }
            
            post {
                always {
                    script {
                        try {
                            if (fileExists('test-results.xml')) {
                                junit testResultsPattern: 'test-results.xml',
                                      allowEmptyResults: false,
                                      skipPublishingChecks: true
                                echo "‚úÖ Rapports de tests publi√©s dans Jenkins"
                            }
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Impossible de publier les r√©sultats JUnit: ${e.getMessage()}"
                        }
                        
                        try {
                            if (fileExists('test-report.html')) {
                                archiveArtifacts artifacts: 'test-report.html',
                                               fingerprint: true,
                                               allowEmptyArchive: true
                            }
                            if (fileExists('htmlcov/index.html')) {
                                archiveArtifacts artifacts: 'htmlcov/**/*',
                                               fingerprint: true,
                                               allowEmptyArchive: true
                            }
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Archivage partiel: ${e.getMessage()}"
                        }
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo 'üéâ BUILD R√âUSSI!'
            echo '‚úÖ Tous les tests sont pass√©s avec succ√®s'
        }
        
        failure {
            echo '‚ùå BUILD √âCHOU√â!'
            echo 'üîç V√©rifiez les logs ci-dessus pour identifier le probl√®me'
        }
        
        unstable {
            echo '‚ö†Ô∏è BUILD INSTABLE!'
            echo 'üß™ Des tests ont √©chou√© mais le build continue'
        }
    }
}
