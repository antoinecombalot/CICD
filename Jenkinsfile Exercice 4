pipeline {
    agent {
        docker {
            image 'python:3.11-slim'
            args '-u root'
        }
    }
    
    environment {
        PYTHONPATH = "${WORKSPACE}/backend"
        BUILD_VERSION = "1.0.${env.BUILD_NUMBER}"
        ARTIFACT_PREFIX = "cicd-project-${env.BUILD_VERSION}"
    }
    
    stages {
        stage('üîç Checkout & Info') {
            steps {
                echo "üöÄ D√©marrage pipeline ${env.BUILD_VERSION}"
                sh '''
                    echo "‚úÖ Code source r√©cup√©r√©"
                    ls -la
                    echo "üêç Fichiers Python:"
                    find . -name "*.py" -type f
                '''
            }
        }
        
        stage('üîß Setup Environment') {
            steps {
                echo 'üîß Configuration environnement'
                sh '''
                    pip install --upgrade pip
                    apt-get update && apt-get install -y zip unzip
                    
                    if [ -f "requirements.txt" ]; then
                        pip install -r requirements.txt
                    else
                        pip install flask flask-cors requests
                    fi
                    
                    pip install pytest pytest-html pytest-cov
                    echo "‚úÖ Environnement pr√™t"
                '''
            }
        }
        
        stage('üß™ Run Tests') {
            steps {
                echo 'üß™ Ex√©cution des tests'
                sh '''
                    export PYTHONPATH="${WORKSPACE}/backend"
                    
                    pytest -v \\
                        --junitxml=test-results.xml \\
                        --html=test-report.html \\
                        --self-contained-html \\
                        backend/ || TEST_EXIT_CODE=$?
                    
                    if [ "${TEST_EXIT_CODE:-0}" -ne 0 ]; then
                        echo "‚ùå Tests √©chou√©s - arr√™t du build"
                        exit ${TEST_EXIT_CODE}
                    else
                        echo "‚úÖ Tests r√©ussis"
                    fi
                '''
            }
            
            post {
                always {
                    junit 'test-results.xml'
                    archiveArtifacts artifacts: 'test-report.html', allowEmptyArchive: true
                }
            }
        }
        
        stage('üì¶ Build Frontend') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                echo 'üé® Build Frontend'
                sh '''
                    mkdir -p dist/frontend
                    
                    if [ -d "frontend" ]; then
                        cp -r frontend/* dist/frontend/
                        echo "‚úÖ Frontend copi√©"
                    else
                        echo "<h1>Demo Frontend v${BUILD_VERSION}</h1>" > dist/frontend/index.html
                        echo "‚úÖ Frontend demo cr√©√©"
                    fi
                    
                    echo "Build: ${BUILD_VERSION}" > dist/frontend/version.txt
                    echo "Date: $(date)" >> dist/frontend/version.txt
                    
                    cd dist
                    zip -r "${ARTIFACT_PREFIX}-frontend.zip" frontend/
                    cd ..
                    
                    echo "‚úÖ Frontend packag√©"
                '''
            }
        }
        
        stage('üêç Build Backend') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                echo '‚öôÔ∏è Build Backend'
                sh '''
                    mkdir -p dist/backend
                    
                    if [ -d "backend" ]; then
                        echo "üìÇ Copie des fichiers backend"
                        for file in backend/*.py; do
                            if [[ "$file" != *test* ]]; then
                                cp "$file" dist/backend/
                                echo "Copi√©: $(basename "$file")"
                            fi
                        done
                        
                        [ -f "requirements.txt" ] && cp requirements.txt dist/backend/
                        
                        echo "üìù Cr√©ation version.py"
                        cat > dist/backend/version.py << VEOF
BUILD_VERSION = "${BUILD_VERSION}"
BUILD_DATE = "$(date)"
BUILD_NUMBER = "${BUILD_NUMBER}"

def get_version_info():
    return {
        "version": BUILD_VERSION,
        "build_date": BUILD_DATE,
        "build_number": BUILD_NUMBER
    }
VEOF
                        
                        echo "üìù Cr√©ation start.py"
                        cat > dist/backend/start.py << SEOF
#!/usr/bin/env python3
import os
import sys

sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

try:
    from app import app
    from version import get_version_info
    
    print("üöÄ D√©marrage backend")
    print(f"üì¶ Version: {get_version_info()}")
    
    app.run(host='0.0.0.0', port=5000, debug=False)
    
except ImportError as e:
    print(f"‚ùå Erreur import: {e}")
    sys.exit(1)
except Exception as e:
    print(f"‚ùå Erreur: {e}")
    sys.exit(1)
SEOF
                        
                        cd dist
                        zip -r "${ARTIFACT_PREFIX}-backend.zip" backend/
                        cd ..
                        
                        echo "‚úÖ Backend packag√©"
                        ls -la dist/backend/
                        
                    else
                        echo "‚ùå Dossier backend introuvable"
                        exit 1
                    fi
                '''
            }
        }
        
        stage('üìä Build Summary') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                sh '''
                    echo "üéØ R√âSUM√â DU BUILD"
                    echo "Version: ${BUILD_VERSION}"
                    echo "Date: $(date)"
                    
                    if [ -d "dist" ]; then
                        echo "üìÅ Artefacts:"
                        ls -la dist/
                        
                        cat > dist/build-info.json << BEOF
{
    "build_version": "${BUILD_VERSION}",
    "build_number": "${BUILD_NUMBER}",
    "build_date": "$(date -Iseconds)",
    "artifacts": [
        "${ARTIFACT_PREFIX}-frontend.zip",
        "${ARTIFACT_PREFIX}-backend.zip"
    ]
}
BEOF
                        
                        echo "‚úÖ M√©tadonn√©es cr√©√©es"
                    else
                        echo "‚ùå Aucun artefact"
                        exit 1
                    fi
                '''
            }
        }
    }
    
    post {
        always {
            script {
                try {
                    if (fileExists('dist/')) {
                        archiveArtifacts artifacts: 'dist/*.zip, dist/*.json', 
                                       fingerprint: true, 
                                       allowEmptyArchive: false
                        echo "‚úÖ Artefacts archiv√©s"
                    }
                } catch (Exception e) {
                    echo "‚ö†Ô∏è Archivage partiel: ${e.getMessage()}"
                }
            }
        }
        
        success {
            echo 'üéâ BUILD ET LIVRAISON R√âUSSIS!'
        }
        
        failure {
            echo '‚ùå BUILD √âCHOU√â!'
        }
        
        unstable {
            echo '‚ö†Ô∏è BUILD INSTABLE!'
        }
    }
}
