pipeline {
    agent {
        docker {
            image 'python:3.11-slim'
            args '-u root'
        }
    }
    
    environment {
        PYTHONPATH = "${WORKSPACE}/backend"
        BUILD_VERSION = "1.0.${env.BUILD_NUMBER}"
        ARTIFACT_PREFIX = "cicd-project-${env.BUILD_VERSION}"
        DEPLOY_SERVER = credentials('deploy-server-ip')
        DEPLOY_USER = 'deploy'
    }
    
    stages {
        stage('üîç Checkout & Info') {
            steps {
                echo "üöÄ Pipeline ${env.BUILD_VERSION}"
                sh 'ls -la && find . -name "*.py"'
            }
        }
        
        stage('üîß Setup Environment') {
            steps {
                sh '''
                    pip install --upgrade pip
                    apt-get update && apt-get install -y zip unzip openssh-client
                    pip install flask flask-cors requests pytest pytest-html pytest-cov
                '''
            }
        }
        
        stage('üß™ Run Tests') {
            steps {
                sh '''
                    export PYTHONPATH="${WORKSPACE}/backend"
                    pytest -v --junitxml=test-results.xml --html=test-report.html backend/
                    
                    if [ $? -ne 0 ]; then
                        echo "‚ùå Tests √©chou√©s"
                        exit 1
                    fi
                '''
            }
            post {
                always {
                    junit 'test-results.xml'
                    archiveArtifacts 'test-report.html'
                }
            }
        }
        
        stage('üì¶ Build Packages') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                sh '''
                    mkdir -p dist/frontend dist/backend
                    
                    # Frontend
                    if [ -d "frontend" ]; then
                        cp -r frontend/* dist/frontend/
                    else
                        cat > dist/frontend/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>CICD App v${BUILD_VERSION}</title>
    <style>body{font-family:Arial;margin:50px;text-align:center}</style>
</head>
<body>
    <h1>üöÄ Application CICD</h1>
    <p>‚úÖ D√©ploy√©e automatiquement par Jenkins</p>
    <p>Version: ${BUILD_VERSION}</p>
    <p>Date: $(date)</p>
    <hr>
    <p><a href="http://$(hostname):5000/">üîó API Backend</a></p>
</body>
</html>
EOF
                    fi
                    
                    # Backend - copie simple et efficace
                    cp backend/app.py dist/backend/
                    [ -f "requirements.txt" ] && cp requirements.txt dist/backend/
                    
                    # Script de d√©marrage simple
                    cat > dist/backend/run_app.py << 'EOF'
#!/usr/bin/env python3
import sys, os
sys.path.insert(0, os.path.dirname(__file__))

from app import app
print(f"üöÄ D√©marrage backend - Build ${BUILD_VERSION}")
app.run(host='0.0.0.0', port=5000, debug=False)
EOF
                    
                    # Service systemd simple
                    cat > dist/backend/backend.service << 'EOF'
[Unit]
Description=Backend CICD App
After=network.target

[Service]
Type=simple
User=deploy
WorkingDirectory=/opt/backend-app
ExecStart=/usr/bin/python3 run_app.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
                    
                    # Archives
                    cd dist
                    zip -r "${ARTIFACT_PREFIX}-frontend.zip" frontend/
                    zip -r "${ARTIFACT_PREFIX}-backend.zip" backend/
                    cd ..
                    
                    echo "‚úÖ Packages cr√©√©s"
                    ls -la dist/
                '''
            }
        }
        
        stage('üöÄ Deploy Frontend') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                echo 'üåê D√©ploiement Frontend'
                sshagent(['deploy-ssh-key']) {
                    sh '''
                        # Copie de l'archive
                        scp -o StrictHostKeyChecking=no "dist/${ARTIFACT_PREFIX}-frontend.zip" ${DEPLOY_USER}@${DEPLOY_SERVER}:/tmp/
                        
                        # D√©ploiement simplifi√©
                        ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} << 'EOF'
echo "üóÇÔ∏è Sauvegarde frontend"
sudo mkdir -p /var/backups/frontend
sudo cp -r /var/www/html /var/backups/frontend/backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || true

echo "üßπ Nettoyage"
sudo rm -rf /var/www/html/*

echo "üì¶ Extraction"
cd /tmp
unzip -o ${ARTIFACT_PREFIX}-frontend.zip
sudo cp -r frontend/* /var/www/html/
sudo chown -R www-data:www-data /var/www/html
sudo chmod -R 755 /var/www/html

echo "üîÑ Reload Apache"
sudo systemctl reload apache2

echo "‚úÖ Frontend d√©ploy√©"
EOF
                    '''
                }
            }
        }
        
        stage('‚öôÔ∏è Deploy Backend') {
            when {
                expression { currentBuild.result != 'FAILURE' }
            }
            steps {
                echo 'üêç D√©ploiement Backend'
                sshagent(['deploy-ssh-key']) {
                    sh '''
                        # Copie de l'archive
                        scp -o StrictHostKeyChecking=no "dist/${ARTIFACT_PREFIX}-backend.zip" ${DEPLOY_USER}@${DEPLOY_SERVER}:/tmp/
                        
                        # D√©ploiement backend
                        ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} << 'EOF'
echo "üõë Arr√™t service backend"
sudo systemctl stop backend-app 2>/dev/null || echo "Service non install√©"

echo "üóÇÔ∏è Sauvegarde backend"
sudo mkdir -p /var/backups/backend
sudo cp -r /opt/backend-app /var/backups/backend/backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || true

echo "üìÅ Pr√©paration r√©pertoire"
sudo mkdir -p /opt/backend-app
sudo rm -rf /opt/backend-app/*

echo "üì¶ Extraction"
cd /tmp
unzip -o ${ARTIFACT_PREFIX}-backend.zip
sudo cp -r backend/* /opt/backend-app/
sudo chown -R deploy:deploy /opt/backend-app
sudo chmod +x /opt/backend-app/run_app.py

echo "üîß Installation d√©pendances"
cd /opt/backend-app
sudo apt-get update -qq
sudo apt-get install -y python3-pip
pip3 install --user flask flask-cors requests

echo "‚öôÔ∏è Configuration service"
sudo cp backend.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable backend-app

echo "üöÄ D√©marrage service"
sudo systemctl start backend-app

echo "‚è±Ô∏è Attente d√©marrage..."
sleep 5

echo "üìä Statut service"
sudo systemctl status backend-app --no-pager -l

echo "‚úÖ Backend d√©ploy√©"
EOF
                    '''
                }
            }
        }
        
        stage('üß™ Verification') {
            steps {
                echo 'üîç Tests de v√©rification'
                sshagent(['deploy-ssh-key']) {
                    sh '''
                        sleep 10  # Attente suppl√©mentaire pour le backend
                        
                        echo "üåê Test Frontend"
                        FRONTEND_STATUS=$(ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} "curl -s -o /dev/null -w '%{http_code}' http://localhost/")
                        echo "Frontend Status: $FRONTEND_STATUS"
                        
                        echo "üêç Test Backend"  
                        BACKEND_STATUS=$(ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} "curl -s -o /dev/null -w '%{http_code}' http://localhost:5000/" || echo "000")
                        echo "Backend Status: $BACKEND_STATUS"
                        
                        echo "üìä Services Status"
                        ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_SERVER} "
                            echo 'Apache:' && sudo systemctl is-active apache2
                            echo 'Backend:' && sudo systemctl is-active backend-app  
                            echo 'Backend Logs:' && sudo journalctl -u backend-app --no-pager -n 5
                        "
                        
                        # Validation
                        if [ "$FRONTEND_STATUS" = "200" ]; then
                            echo "‚úÖ Frontend OK"
                        else
                            echo "‚ùå Frontend KO"
                        fi
                        
                        if [ "$BACKEND_STATUS" = "200" ]; then
                            echo "‚úÖ Backend OK"  
                        else
                            echo "‚ö†Ô∏è Backend en cours de d√©marrage..."
                        fi
                    '''
                }
            }
        }
    }
    
    post {
        always {
            archiveArtifacts artifacts: 'dist/*.zip', fingerprint: true
        }
        
        success {
            echo 'üéâ D√âPLOIEMENT R√âUSSI!'
            echo "‚úÖ Frontend: http://${env.DEPLOY_SERVER}/"
            echo "‚úÖ Backend: http://${env.DEPLOY_SERVER}:5000/"
        }
        
        failure {
            echo '‚ùå D√âPLOIEMENT √âCHOU√â!'
        }
    }
}
