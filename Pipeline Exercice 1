pipeline {
    agent {
        docker {
            image 'debian:13-slim'
            args '--user root -v /tmp:/tmp'
        }
    }
    
    stages {
        stage('Setup') {
            steps {
                sh '''
                    echo "ðŸ”§ Installation des paquets nÃ©cessaires"
                    apt-get update
                    apt-get install -y procps coreutils util-linux
                    echo "âœ… Paquets installÃ©s"
                '''
            }
        }
        
        stage('Generate File') {
            steps {
                sh '''
                    echo "ðŸ“ GÃ©nÃ©ration du fichier systÃ¨me"
                    
                    DATE=$(date)
                    HOSTNAME=$(hostname)
                    CPU_CORES=$(nproc)
                    RAM_INFO=$(grep MemTotal /proc/meminfo | awk '{print $2 " " $3}')
                    DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
                    
                    echo "ðŸ“Š Informations collectÃ©es:"
                    echo "Date: $DATE"
                    echo "Hostname: $HOSTNAME"
                    echo "CPU: $CPU_CORES coeurs"
                    echo "RAM: $RAM_INFO"
                    echo "Disque: $DISK_USAGE% utilisÃ©"
                    
                    cat > /tmp/exercice1.log << EOF
-----
ExÃ©cution de la pipeline Jenkins Exercice 1
DÃ©but d'exÃ©cution Ã  $DATE sur $HOSTNAME
Cette machine dispose de $CPU_CORES coeurs de CPU, et $RAM_INFO de RAM.
Le disque principal est utilisÃ© Ã  $DISK_USAGE%.
-----
EOF
                    
                    echo "âœ… Fichier /tmp/exercice1.log crÃ©Ã©!"
                '''
            }
        }
        
        stage('Verification') {
            steps {
                sh '''
                    echo "ðŸ” VÃ©rification du fichier gÃ©nÃ©rÃ©"
                    ls -la /tmp/exercice1.log
                    echo ""
                    echo "ðŸ“„ Contenu final:"
                    cat /tmp/exercice1.log
                '''
            }
        }
    }
    
    post {
        success {
            echo 'ðŸŽ‰ Pipeline Docker rÃ©ussie!'
            // VÃ©rification sur l'hÃ´te que le fichier est accessible
            script {
                sh 'echo "Fichier accessible sur l\'hÃ´te:" && ls -la /tmp/exercice1.log || echo "Fichier non accessible sur l\'hÃ´te"'
            }
        }
        failure {
            echo 'âŒ Ã‰chec de la pipeline Docker'
        }
    }
}
