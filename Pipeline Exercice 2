pipeline {
    agent {
        docker {
            image 'python:3.11-slim'
            args '-u root'
        }
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Clonage du projet Python'
                git branch: 'main',
                    url: 'https://github.com/tom-dab/cicd-project.git'
                
                sh '''
                    echo "‚úÖ Projet clon√©"
                    ls -la
                    echo "üìÅ Structure du projet:"
                    find . -name "*.py" | head -5
                    echo ""
                    echo "üìã Contenu backend:"
                    ls -la backend/
                    echo ""
                    echo "üìã Contenu frontend:"
                    ls -la frontend/ || echo "Pas de dossier frontend"
                '''
            }
        }
        
        stage('Analyze Dependencies') {
            steps {
                sh '''
                    echo "üîç Analyse des d√©pendances requises"
                    
                    # Recherche des imports dans les fichiers Python
                    echo "üì¶ Imports d√©tect√©s:"
                    grep -h "^from\\|^import" backend/*.py || true
                    grep -h "^from\\|^import" frontend/*.py 2>/dev/null || true
                    
                    # V√©rification des fichiers de d√©pendances
                    echo ""
                    echo "üìÑ Fichiers de d√©pendances:"
                    ls -la requirements.txt setup.py pyproject.toml 2>/dev/null || echo "Aucun fichier de d√©pendances trouv√©"
                    
                    # Affichage du contenu de requirements.txt s'il existe
                    if [ -f "requirements.txt" ]; then
                        echo ""
                        echo "üìã Contenu de requirements.txt:"
                        cat requirements.txt
                    fi
                '''
            }
        }
        
        stage('Setup & Install Dependencies') {
            steps {
                sh '''
                    echo "üîß Installation des d√©pendances"
                    python -m pip install --upgrade pip
                    
                    # Installation des d√©pendances du projet
                    if [ -f "requirements.txt" ]; then
                        echo "üì¶ Installation via requirements.txt"
                        pip install -r requirements.txt
                    else
                        echo "üì¶ Installation manuelle des d√©pendances d√©tect√©es"
                        # Installation de Flask et d√©pendances courantes pour ce type de projet
                        pip install flask flask-cors requests
                    fi
                    
                    # Installation des outils de test
                    pip install pytest pytest-html pytest-cov
                    
                    echo "‚úÖ D√©pendances install√©es"
                    pip list | grep -E "(flask|pytest)"
                '''
            }
        }
        
        stage('Run Tests') {
            steps {
                sh '''
                    echo "üß™ Ex√©cution des tests Python"
                    
                    # Configuration du PYTHONPATH pour importer les modules
                    export PYTHONPATH="${PYTHONPATH}:${PWD}/backend"
                    
                    # Ex√©cution des tests depuis le r√©pertoire racine
                    pytest -v \\
                        --junitxml=results.xml \\
                        --html=report.html \\
                        --self-contained-html \\
                        --cov=backend \\
                        --cov-report=html \\
                        --cov-report=term \\
                        backend/ || echo "Tests termin√©s avec erreurs"
                    
                    echo "üìä R√©sultats g√©n√©r√©s:"
                    ls -la *.xml *.html htmlcov/ 2>/dev/null || echo "Certains rapports manquants"
                '''
            }
            
            post {
                always {
                    script {
                        try {
                            if (fileExists('results.xml')) {
                                junit 'results.xml'
                            }
                            if (fileExists('report.html')) {
                                archiveArtifacts artifacts: 'report.html'
                            }
                            if (fileExists('htmlcov/index.html')) {
                                archiveArtifacts artifacts: 'htmlcov/**/*'
                            }
                        } catch (Exception e) {
                            echo "Archivage partiel: ${e.getMessage()}"
                        }
                    }
                }
            }
        }
        
        stage('Test Results Summary') {
            steps {
                sh '''
                    echo "üìä R√©sum√© des tests"
                    echo "==================="
                    
                    if [ -f "results.xml" ]; then
                        # Extraction des statistiques
                        tests=$(grep -o 'tests="[^"]*"' results.xml | cut -d'"' -f2)
                        failures=$(grep -o 'failures="[^"]*"' results.xml | cut -d'"' -f2)
                        errors=$(grep -o 'errors="[^"]*"' results.xml | cut -d'"' -f2)
                        
                        echo "üìà R√©sultats:"
                        echo "Total tests: ${tests:-0}"
                        echo "√âchecs: ${failures:-0}"
                        echo "Erreurs: ${errors:-0}"
                        echo "Succ√®s: $((${tests:-0} - ${failures:-0} - ${errors:-0}))"
                        
                        if [ "${failures:-0}" -eq 0 ] && [ "${errors:-0}" -eq 0 ] && [ "${tests:-0}" -gt 0 ]; then
                            echo "‚úÖ TOUS LES TESTS SONT PASS√âS!"
                        elif [ "${tests:-0}" -eq 0 ]; then
                            echo "‚ö†Ô∏è AUCUN TEST EX√âCUT√â"
                        else
                            echo "‚ùå IL Y A DES PROBL√àMES DANS LES TESTS"
                        fi
                        
                        # D√©tails des tests
                        echo ""
                        echo "üìã D√©tails des tests:"
                        grep '<testcase' results.xml | sed 's/.*name="\\([^"]*\\)".*/- \\1/' || echo "Pas de d√©tails disponibles"
                    else
                        echo "‚ùå Aucun rapport de test trouv√©"
                    fi
                '''
            }
        }
    }
    
    post {
        always {
            echo 'üßπ Nettoyage termin√©'
        }
        
        success {
            echo 'üéâ Pipeline Python r√©ussie!'
            echo '‚úÖ Projet clon√©, d√©pendances install√©es, tests ex√©cut√©s'
        }
        
        failure {
            echo '‚ùå √âchec de la pipeline Python'
        }
        
        unstable {
            echo '‚ö†Ô∏è Pipeline instable - des tests ont √©chou√© mais la pipeline continue'
        }
    }
}
